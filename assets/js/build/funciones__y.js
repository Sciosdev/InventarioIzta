import{getApi,getApiFiltros,postApi,deleteApi,putApi}from"./api/funcionesApi.js";import{modalActivo,tablas,filtros,validacionesFormularios,nombreTabla,idEditar,datos,divTabla,bienesModal,datosSelect}from"./variables.js";export function eventoFiltro(e){e.addEventListener("change",(function(){const n=e.getAttribute("data-campo");filtros.value[n]=e.value}))}export function limpiaTabla(e){const n=e.querySelector("table");for(;n.firstChild;)n.removeChild(n.firstChild)}export function limpiaHTML(e){for(;e.firstChild;)e.removeChild(e.firstChild)}export function mostrarTabla(e=nombreTabla,n=!0){const a=document.querySelector(`.${e} table`);console.log(e),limpiaTabla(divTabla),eliminarSpiner();const o=tablas[nombreTabla].columnas,l=document.createElement("THEAD"),t=document.createElement("TR");t.classList.add("fs-6"),o.forEach((e=>{const n=document.createElement("TH");n.scope="col",n.textContent=e.field,t.appendChild(n)})),l.appendChild(t);const r=document.createElement("TBODY");datos.value.forEach((e=>{const a=document.createElement("TR");a.classList.add("fs-6","fila"),a.setAttribute("data-id",e.id),a.onclick=function(){n&&seleccionandoFila(a)},o.forEach((n=>{const o=document.createElement("TD");o.textContent=e[n.campo],a.appendChild(o)})),r.appendChild(a)})),a.appendChild(l),a.appendChild(r),n&&$(document).ready((function(){$("#tabla").DataTable({destroy:!0,searching:!0,pageLength:25,lengthMenu:[10,25,50,100],language:{url:"https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-MX.json"}})}))}export function crearFormulario(e,n=[]){switch(e){case"bienes":return formularioBienes();case"tipos":return formularioTipos(n);case"edificios":return formularioEdificios(n);case"areas":return formularioAreas(n);case"responsables":return formularioResponsables(n);default:console.error("Tabla no reconocida:",e)}}export function mostrarErrores(e,n,a){limpiarAlertas();const o=document.createElement("DIV");o.classList.add("row","p-1","div-alertas"),e.forEach((a=>{const l=document.createElement("DIV");l.classList.add("col-12",1===e.length?"col-sm-12":"col-sm-6");const t=document.createElement("DIV");t.textContent=a,t.classList.add("alert","ext-uppercase","fs-6",`alert-${n}`),l.appendChild(t),o.appendChild(l)})),a.parentElement.insertBefore(o,a)}function limpiarAlertas(){const e=document.querySelector(".div-alertas");e&&e.remove()}export function mostrarAlerta(e,n,a){cerraModal(e);const o=document.createElement("div");o.classList.add("modal","fade"),o.tabIndex=-1,o.setAttribute("aria-hidden","true"),o.innerHTML=`\n    <div class="modal-dialog modal-sm">\n        <div class="modal-content ${"success"===e?"bg-success":"danger"===e?"bg-danger":"warning"===e?"bg-warning":""}">\n            <div class="modal-body p-4">\n                <div class="text-center">\n                    <i class="ri-${"success"===e?"check-line":"warning"===e?"alert-line":"danger"===e?"close-circle-line":""} h1 ${"success"===e?"text-light":"warning"===e?"text-warning":"danger"===e?"text-light":""}"></i>\n                    <h4 class="mt-2 text-white">${n}</h4> \x3c!-- Color blanco --\x3e\n                    <p class="mt-3 text-white">${a}</p> \x3c!-- Color blanco --\x3e\n                    <button \n                        type="button" \n                        class="btn btn-light my-2" \n                        ${"danger"===e?'id="retryButton"':""} \n                    >\n                        ${"danger"===e?"Reintentar":"Aceptar"}\n                    </button>\n                </div>\n            </div>\n        </div>\n    </div>\n`,document.body.appendChild(o);const l=new bootstrap.Modal(o);l.show();o.querySelector("button").addEventListener("click",(()=>{l.hide()})),o.addEventListener("hidden.bs.modal",(()=>{o.remove()}))}export function crearScrollableModal(e,n,a,o="guardar"){const l=document.getElementById(e);l&&l.parentNode.removeChild(l);const t=`\n    <div class="modal fade" id="${e}" tabindex="-1" role="dialog" aria-labelledby="${e}Label" aria-hidden="true">\n        <div class="modal-dialog modal-dialog-scrollable" role="document">\n            <div class="modal-content">\n                <div class="modal-header">\n                    <h5 class="modal-title" id="${e}Label">${n}</h5>\n                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n                </div>\n                <div class="modal-body">\n                    ${a}\n                </div>\n                <div class="modal-footer">\n                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>\n                    <button type="button" class="btn btn-primary text-capitalize ${o}">${o}</button>\n                </div>\n            </div>\n        </div>\n    </div>\n`;document.getElementById("modalContainer").innerHTML=t;const r=new bootstrap.Modal(document.getElementById(e));r.show(),modalActivo.value=r}function cerraModal(e="success"){if(modalActivo.value&&"success"===e){modalActivo.value.hide(),modalActivo.value=null;document.querySelector(".modal").remove()}}export function spinner(e=e){const n=document.createElement("DIV");n.classList.add("d-flex","justify-content-center");const a=document.createElement("DIV");a.classList.add("spinner-border","spinner"),a.rol="status",n.appendChild(a),e.appendChild(n)}function eliminarSpiner(){document.querySelector(".spinner").remove()}export async function consultarSelect(e){for(const n of e)if("SELECT"===n.tagName&&"tipo_inventario"!==n.id){const e="autorizador"===n.id?"responsables":n.id,a=`${window.location.origin}/api/index.php/${e}`,o=await getApi(a);datosSelect[n.id]=o}llenarSelect(e)}export function llenarSelect(e){e.forEach((e=>{const n=e.id;datosSelect[n].forEach((n=>{const a=document.createElement("OPTION"),o=e.getAttribute("data-campo");a.textContent=n[o],a.value=n.id,e.appendChild(a)}))}))}function seleccionandoFila(e){const n=document.querySelector("tbody .table-active");n&&(n.classList.remove("table-active"),localStorage.setItem("registro",JSON.stringify({}))),n!==e?e.classList.add("table-active"):(e.classList.remove("table-active"),localStorage.setItem("registro",JSON.stringify({})))}function formularioBienes(){const e=document.createElement("FORM");return e.classList.add("formulario","p-2"),e.innerHTML='\n        <div class="row g-3 fs-6">\n            <div class="col-md-6">\n                <label class="form-label" for="num_inventario">Número Inventario</label>\n                <input type="text" class="form-control fs-6 num_inventario" id="num_inventario" placeholder="Ejemplo: 554821" name="numero_inventario">\n            </div>\n            <div class="col-md-6">\n                <label for="tipo_inventario" class="form-label">Tipo Inventario</label>\n                <select class="form-select fs-6 tipo_inventario" id="tipo_inventario" name="tipo_inventario"  data-campo="tipo_inventario">\n                    <option value="" selected>Seleccionar</option>\n                    <option value="Unam">Unam</option>\n                    <option value="Fesi">Fesi</option>\n                    <option value="SinInv">Sin Inventario</option>\n                </select>\n            </div>\n            <div class="col-md-6">\n                <label for="tipos-bien" class="form-label">Tipo de Bien</label>\n                <select class="form-select fs-6 tipos-bien" id="tipos" name="tipo_bien_id" data-campo="tipobien">\n                    <option value="" selected>Seleccionar</option>\n                </select>\n            </div>\n            <div class="col-md-12">\n                <label for="descripcion" class="form-label">Descripcion</label>\n                <input type="text" class="form-control fs-6 descripcion" id="descripcion" name="descripcion" placeholder="Ejemplo: Laptop HP 15 pulgadas">\n            </div>\n            <div class="col-md-6">\n                <label for="numero_serie" class="form-label">Numero serie</label>\n                <input type="text" class="form-control fs-6 numero_serie" id="numero_serie" name="numero_serie" placeholder="Ejemplo: SN-2023-001">\n            </div>\n            <div class="col-md-6">\n                <label for="marca" class="form-label">Marca</label>\n                <input type="text" class="form-control fs-6 marca" id="marca" name="marca" placeholder="Ejemplo: HP">\n            </div>\n            <div class="col-md-6">\n                <label for="modelo" class="form-label">Modelo</label>\n                <input type="text" class="form-control fs-6 modelo" id="modelo" name="modelo" placeholder="Ejemplo: Pavilion 15">\n            </div>\n            <div class="col-md-6">\n                <label for="autorizador" class="form-label">Autorizador</label>\n                <select class="form-select fs-6 autorizador" id="responsables" name="autorizador" data-campo="nombre_responsable">\n                    <option value="" selected>Seleccionar</option>\n                </select>\n            </div>\n            <div class="col-md-6">\n                <label for="responsables" class="form-label">Responsable</label>\n                <select class="form-select fs-6 responsable_id" id="responsables" name="responsable_id" data-campo="nombre_responsable">\n                    <option value="" selected>Seleccionar</option>\n                </select>\n            </div>\n            <div class="col-md-6">\n                <label for="areas" class="form-label">Area</label>\n                <select class="form-select fs-6 area" id="areas" name="area_id" data-campo="nombre_area">\n                    <option value="" selected>Seleccionar</option>\n                </select>\n            </div>\n            <div class="col-md-6">\n                <label for="edificios" class="form-label">Edificio</label>\n                <select class="form-select fs-6 edificio" id="edificios" name="edificio_id" data-campo="nombreedif">\n                    <option value="" selected>Seleccionar</option>\n                </select>\n            </div>\n             <div class="col-md-6">\n                <label for="transferencia" class="form-label">Transferncia</label>\n                <input type="text" class="form-control fs-6 filtro" id="transferencia" placeholder="Ejemplo: 1" name="transferencia" data-campo="transferencia">\n            </div>\n            <div class="col-md-12">\n                <label for="ubicacion" class="form-label">Ubicacion</label>\n                <input type="text" class="form-control fs-6 ubicacion" id="ubicacion" name="ubicacion" placeholder="Segundo piso, aula de informática">\n            </div>  \n        </div>\n\n',e}function formularioTipos(e={}){const n=document.createElement("FORM");return n.classList.add("formulario","p-2"),n.innerHTML=`\n        <div class="row g-3 fs-6">\n            <div class="col-md-4">\n                <label class="form-label" for="cvetpo">Clave</label>\n                <input type="text" class="form-control fs-6 cvetpo" id="cvetpo" placeholder="Ejemplo: TB005" name="cvetpo" value="${e.cvetpo?e.cvetpo:""}">\n            </div>\n            \x3c!--Nombre Tipo de Bien --\x3e\n            <div class="col-md-8">\n                <label class="form-label" for="tipo-bien">Nombre</label>\n                <input type="text" class="form-control fs-6 tipobien" id="tipo-bien" placeholder="Ejemplo: Escritorio" name="tipobien" value="${e.tipobien?e.tipobien:""}">\n            </div> \n        </div>\n`,n}function formularioEdificios(e={}){const n=document.createElement("FORM");return n.classList.add("formulario","p-2"),n.innerHTML=`\n        <div class="row g-3 fs-6">\n            \x3c!-- Clave del Edificio --\x3e\n            <div class="col-md-4">\n                <label class="form-label" for="clave">Clave</label>\n                <input \n                    type="text" \n                    class="form-control fs-6 clave" \n                    id="clave" \n                    name="cveedif" \n                    placeholder="Ejemplo: E003" \n                    value="${e.cveedif||""}">\n            </div>\n\n            \x3c!-- Nombre del Edificio --\x3e\n            <div class="col-md-8">\n                <label class="form-label" for="nombre_edificio">Nombre</label>\n                <input \n                    type="text" \n                    class="form-control fs-6 nombre_edificio" \n                    id="nombre_edificio" \n                    name="nombreedif" \n                    placeholder="Ejemplo: Edificio de Gobierno" \n                    value="${e.nombreedif||""}">\n            </div>\n        </div>\n    `,n}function formularioAreas(e={}){const n=document.createElement("FORM");return n.classList.add("formulario","p-2"),n.innerHTML=`\n        <div class="row g-3 fs-6">\n            \x3c!-- Clave del Área --\x3e\n            <div class="col-md-4">\n                <label class="form-label" for="cve_area">Clave</label>\n                <input \n                    type="text" \n                    class="form-control fs-6 cve_area" \n                    id="cve_area" \n                    name="cve_area" \n                    placeholder="Ejemplo: A005" \n                    value="${e.cve_area||""}">\n            </div>\n\n            \x3c!-- Nombre del Área --\x3e\n            <div class="col-md-8">\n                <label class="form-label" for="nombre_area">Nombre</label>\n                <input \n                    type="text" \n                    class="form-control fs-6 nombre_area" \n                    id="nombre_area" \n                    name="nombre_area" \n                    placeholder="Ejemplo: Recursos Humanos" \n                    value="${e.nombre_area||""}">\n            </div>\n        </div>\n    `,n}function formularioResponsables(e={}){const n=document.createElement("FORM");return n.classList.add("formulario","formulario-responsables","p-2"),n.innerHTML=`\n        <div class="row g-3 fs-6">\n            \x3c!-- Nombre del Responsable --\x3e\n            <div class="col-md-12 col-xl-4">\n                <label class="form-label" for="nombre_responsable">Nombre</label>\n                <input \n                    type="text" \n                    class="form-control fs-6 nombre_responsable" \n                    id="nombre_responsable" \n                    name="nombre_responsable" \n                    placeholder="Ejemplo: Juan Pérez" \n                    value="${e.nombre_responsable||""}">\n            </div>\n\n            \x3c!-- RFC --\x3e\n            <div class="col-md-12 col-xl-4">\n                <label class="form-label" for="rfc">RFC</label>\n                <input \n                    type="text" \n                    class="form-control fs-6 rfc" \n                    id="rfc" \n                    name="rfc" \n                    placeholder="Ejemplo: PEJU850912HZ1" \n                    value="${e.rfc||""}">\n            </div>\n\n            \x3c!-- Puesto --\x3e\n            <div class="col-md-12 col-xl-4">\n                <label class="form-label" for="puesto">Puesto</label>\n                <input \n                    type="text" \n                    class="form-control fs-6 puesto" \n                    id="puesto" \n                    name="puesto" \n                    placeholder="Ejemplo: Coordinador Administrativo" \n                    value="${e.puesto||""}">\n            </div>\n        </div>\n        <div id="alertas" class="mt-3"></div>\n    `,n}function formularioUsuarios(e={}){const n=document.createElement("FORM");return n.classList.add("formulario","formulario-responsables","p-2"),n.innerHTML=`\n        <div class="row g-3 fs-6">\n            \x3c!-- Nombre del Usuario --\x3e\n            <div class="col-md-12 col-xl-4">\n                <label class="form-label" for="nombre">Nombre</label>\n                <input \n                    type="text" \n                    class="form-control fs-6 nombre" \n                    id="nombre" \n                    name="nombre" \n                    placeholder="Ejemplo: Juan Pérez" \n                    value="${e.nombre_responsable||""}">\n            </div>\n\n            \x3c!-- Numero de cuenta --\x3e\n            <div class="col-md-12 col-xl-4">\n                <label class="form-label" for="num_cuenta">Numero de cuenta</label>\n                <input \n                    type="text" \n                    class="form-control fs-6 num_cuenta" \n                    id="num_cuenta" \n                    name="num_cuenta" \n                    placeholder="Ejemplo: 19256314" \n                    value="${e.rfc||""}">\n            </div>\n\n            \x3c!-- password --\x3e\n            <div class="mb-3 col-md-12 col-xl-4">\n                <label for="password" class="form-label">Contraseña</label>\n                    <div class="input-group input-group-merge">\n                        <input type="password" id="password" name="password" class="form-control" placeholder="Escribe una contraseña">\n                    <div class="input-group-text" data-password="false">\n                            <span class="password-eye"></span>\n                     </div>\n                </div>\n            </div>\n        </div>\n        <div id="alertas" class="mt-3"></div>\n    `,n}export function llenarFormulario(e){document.querySelectorAll(".formulario select, .formulario input").forEach((n=>{n.value=e[n.name]}))}export function abrirModalConsultaBienes(){const e=document.createElement("FORM");e.classList.add("formulario","p-2"),e.innerHTML='\n            <div class="row g-3 fs-6 contenidoModal">\n                <div class="col-md-6">\n                    <label class="form-label" for="num_inventario">Número Inventario</label>\n                    <input type="text" class="form-control fs-6 num_inventario" id="num_inventarioModal" placeholder="Ejemplo: 554821" name="numero_inventario">\n                </div>\n                <div class="col-md-6 d-flex flex-column align-items-end justify-content-end">\n                    <button type="button" class="btn btn-info text-capitalize consultarModal">Consultar</button>\n                </div>\n                <div class="col-md-6 d-flex divEtiquetas">\n                </div>\n            </div>\n    ',crearScrollableModal("scrollable-modal","Consultar",e.outerHTML,"mostrar");document.querySelector(".consultarModal").addEventListener("click",(function(){const e=document.querySelector("#num_inventarioModal").value.trim();if(!e)return mostrarErrores(["Por favor, ingresa el numero de inventario"],"danger",document.querySelector(".formulario")),void borrarErrores();consultarBien(e)}));document.querySelector(".mostrar").addEventListener("click",(function(){if(0===bienesModal.value.length)return mostrarErrores(["Por favor, primero consulta un bien."],"danger",document.querySelector(".formulario")),void borrarErrores();datos.value=bienesModal.value,bienesModal.value=[],spinner(divTabla),mostrarTabla(!0),cerraModal()}))}async function consultarBien(e){const n={numero_inventario:e};if(bienesModal.value.some((n=>n.numero_inventario==e)))return mostrarErrores(["El numero de inventario ya lo consultaste"],"danger",document.querySelector(".formulario")),void borrarErrores();const a=await getApiFiltros(nombreTabla.value,n);if(0===Object.keys(a).length)return mostrarErrores(["El bien no existe"],"danger",document.querySelector(".formulario")),void borrarErrores();bienesModal.value=[...bienesModal.value,a[0]],mostrarEtiqueta(e),document.querySelector("#num_inventarioModal").value=""}function mostrarEtiqueta(e){const n=document.querySelector(".divEtiquetas"),a=document.createElement("P");a.textContent=e,a.classList.add("badge","badge-outline-success","fs-6","px-2","cursor-pointer","me-1"),a.addEventListener("dblclick",(function(){quitarEtiqueta(this)})),n.appendChild(a)}function quitarEtiqueta(e){const n=e.textContent;bienesModal.value=bienesModal.value.filter((e=>e.numero_inventario!==n)),e.remove()}function borrarErrores(){const e=document.querySelector(".alert");setTimeout((()=>{e.remove()}),3e3)}function validarFormulario(){const e=document.querySelector(".formulario"),n=new FormData(e),a=validacionesFormularios[nombreTabla.value];let o=[],l={};for(let[e,t]of n.entries())t.trim()?l[e]=t:o=[...o,a[e]];if(!(o.length>0))return l;{mostrarErrores(o,"danger",e);const n=document.querySelector(".modal-body");n&&(n.scrollTop=0)}}export function guardar(){document.querySelector(".guardar").addEventListener("click",(function(){const e=validarFormulario();e&&(idEditar.value?(e.modified_by=obtenerId(),actualizar(e)):(e.created_by=obtenerId(),crear(e)))}))}async function crear(e){const n=`/api/index.php/${nombreTabla.value}`,a=await postApi(n,e);if("success"===a.tipo){document.querySelector(".formulario").reset(),mostrarAlerta(a.tipo,a.titulo,a.mensaje),spinner(divTabla),datos.value=a.dato,mostrarTabla(!0)}else mostrarAlerta(a.tipo,a.titulo,a.mensaje)}async function actualizar(e){const n=`/api/index.php/${nombreTabla.value}/${idEditar.value}`,a=await putApi(n,e);if("success"===a.tipo){document.querySelector(".formulario").reset(),mostrarAlerta(a.tipo,a.titulo,a.mensaje),datos.value=datos.value.map((e=>e.id!==idEditar.value?e:a.dato[0])),spinner(divTabla),mostrarTabla(!0),idEditar.value=""}}export async function eliminar(){const e=`/api/index.php/${nombreTabla.value}/${idEditar.value}`,n=await deleteApi(e);"success"===n.tipo&&(mostrarAlerta(n.tipo,n.titulo,n.mensaje),datos.value=datos.value.filter((e=>e.id!==idEditar.value)),spinner(divTabla),mostrarTabla(datos.value,divTabla,nombreTabla.value,!0),idEditar.value="")}export async function consultarRegistros(){spinner(divTabla);const e=`/api/index.php/${nombreTabla.value}`;datos.value=await getApi(e),mostrarTabla(datos,divTabla,nombreTabla.value,!0)}function obtenerId(){return document.getElementById("user-data").getAttribute("data-user-id")}